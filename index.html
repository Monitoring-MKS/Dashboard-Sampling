<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Dashboard - Final Update</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --danger: #e74c3c; --success: #27ae60; --warning: #f39c12; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 0; padding: 10px; color: #333; }
        
        /* Filter Nav */
        .filter-nav { background: white; padding: 12px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 15px; display: flex; flex-direction: column; gap: 10px; position: sticky; top: 0; z-index: 1000; }
        .filter-nav select { padding: 10px; border-radius: 5px; border: 1px solid #ddd; width: 100%; font-size: 1rem; font-weight: bold; }
        
        .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .card h3 { margin-top: 0; color: var(--primary); border-bottom: 2px solid #eee; padding-bottom: 10px; font-size: 0.95rem; text-transform: uppercase; }
        
        /* Stat Card Ringkasan */
        .summary-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #eee; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card .label { display: block; font-size: 0.85rem; font-weight: bold; color: #666; text-transform: uppercase; margin-bottom: 8px; }
        .stat-card .value { display: block; font-size: 2.8rem; font-weight: 800; line-height: 1; }
        .stat-wajib { border-top: 5px solid var(--primary); }
        .stat-wajib .value { color: var(--primary); }
        .stat-done { border-top: 5px solid var(--success); }
        .stat-done .value { color: var(--success); }
        .stat-pending { border-top: 5px solid var(--danger); }
        .stat-pending .value { color: var(--danger); }

        /* NO 2 STYLE */
        #tableTemuan { border-collapse: separate; border-spacing: 0 8px; background: transparent; }
        #tableTemuan thead th { background-color: #f8fafc; color: #64748b; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; border-top: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0; padding: 12px; }
        #tableTemuan tbody tr { background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.02); transition: all 0.2s; }
        #tableTemuan tbody tr:hover { transform: scale(1.01); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        #tableTemuan td { padding: 15px 12px; border: none; }
        #tableTemuan td:first-child { border-radius: 8px 0 0 8px; font-weight: 600; color: var(--primary); }
        #tableTemuan td:last-child { border-radius: 0 8px 8px 0; }
        .pct-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: bold; margin-left: 5px; }
        .pct-selisih { background: #fee2e2; color: #b91c1c; }

        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #fafafa; position: sticky; top: 0; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
        .badge-red { background: #fdecea; color: var(--danger); }
        .badge-green { background: #eafaf1; color: var(--success); }
        .loading { text-align: center; padding: 50px; font-weight: bold; }
        
        /* NO 3 SPECIFIC STYLE */
        .petugas-header { padding: 12px; border-radius: 8px; font-weight: bold; font-size: 0.85rem; margin: 15px 0 10px 0; display: flex; justify-content: space-between; align-items: center; }
        .count-pill { background: white; padding: 2px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 800; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        .kon-list { font-size: 0.85rem; font-weight: bold; color: var(--danger); margin-top: 5px; display: block; }
        .detail-sisa { display: none; margin-top: 10px; }
        .btn-toggle { background: #f8f9fa; border: 1px solid #ddd; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; font-weight: bold; color: var(--primary); }
        @media (min-width: 768px) { .filter-nav { flex-direction: row; } .filter-nav select { width: auto; } body { padding: 20px; } }
    </style>
</head>
<body>

    <div id="loader" class="loading"><i class="fas fa-spinner fa-spin"></i> Memuat Data Dashboard...</div>

    <div id="content" style="display:none;">
        <div class="filter-nav">
            <label style="font-size: 0.8rem; font-weight: bold; display: flex; align-items: center;"><i class="fas fa-calendar-alt" style="margin-right:8px;"></i> FILTER TANGGAL PROSES:</label>
            <select id="globalFilterTgl" onchange="updateDashboard()"></select>
            <button onclick="location.reload()" style="margin-left:auto; padding:10px 15px; cursor:pointer; background: var(--primary); color: white; border: none; border-radius: 5px;"><i class="fas fa-sync"></i> Refresh Data</button>
        </div>

        <div class="card">
            <h3>1. Status Toko Wajib Sampling</h3>
            <div class="summary-container">
                <div class="stat-card stat-wajib"><span class="label">Total Wajib</span><span id="wTotal" class="value">0</span></div>
                <div class="stat-card stat-done"><span class="label">Selesai</span><span id="wDone" class="value">0</span></div>
                <div class="stat-card stat-pending"><span class="label">Belum</span><span id="wPending" class="value">0</span></div>
            </div>
            <div class="table-wrapper" style="max-height:450px; overflow-y: auto;">
                <table id="tableWajib">
                    <thead><tr><th>Informasi Toko</th><th>Monitoring Sisa</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <h3>2. Temuan Selisih (Seluruh Periode)</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <div style="height: 350px;"><canvas id="chartTemuan"></canvas></div>
                <div class="table-wrapper" style="max-height:350px; overflow-y: auto;">
                    <table id="tableTemuan">
                        <thead><tr><th>Tgl Proses</th><th>Sampling</th><th>Selisih & %</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>3. Produktivitas & Shift Petugas</h3>
            
            <div class="petugas-header" style="background: #fff5f5; border-left: 5px solid var(--danger);">
                <span><i class="fas fa-times-circle"></i> BELUM SAMPLING</span>
                <span id="countBelum" class="count-pill" style="color: var(--danger);">0 Orang</span>
            </div>
            <div class="table-wrapper" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;">
                <table id="tablePetugasBelum">
                    <thead><tr><th>Nama Petugas</th><th>NIK</th><th>Shift</th><th>Status</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="petugas-header" style="background: #f0fdf4; border-left: 5px solid var(--success);">
                <span><i class="fas fa-check-circle"></i> SUDAH SAMPLING</span>
                <span id="countSudah" class="count-pill" style="color: var(--success);">0 Orang</span>
            </div>
            <div class="table-wrapper" style="max-height: 400px; overflow-y: auto;">
                <table id="tablePetugasSudah">
                    <thead><tr><th>Nama Petugas</th><th>Shift</th><th>Toko</th><th>Kontainer</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyqVUPM7hS-aH9nr_NHHOSjSEEMwcAS1DClSGRICcl2UZ0nre5_TxIKjw9fbmThJlwS/exec";
        let rawReports = [], rawPetugas = [], rawWajib = [], rawMaster = [];
        let myChart;

        const CATEGORY_WEIGHT = { "P": 100, "S": 200, "M": 300 };

        window.onload = init;

        async function init() {
            try {
                const response = await fetch(SCRIPT_URL + "?get=data");
                const data = await response.json();
                rawReports = data.reports || [];
                rawPetugas = data.petugas || [];
                rawWajib = data.wajibSampling || [];
                rawMaster = data.master || []; 
                setupDateFilter();
                updateDashboard();
                document.getElementById('loader').style.display = 'none';
                document.getElementById('content').style.display = 'block';
            } catch (e) {
                document.getElementById('loader').innerHTML = "<div style='color:red; padding:20px;'>Gagal memuat data dari server. Pastikan koneksi stabil dan Apps Script sudah di-deploy.</div>";
            }
        }

        function setupDateFilter() {
            const select = document.getElementById('globalFilterTgl');
            const dates = [...new Set(rawReports.map(r => r[9]))].filter(Boolean).sort().reverse();
            select.innerHTML = dates.map(d => `<option value="${d}">${d}</option>`).join('');
        }

        function updateDashboard() {
            const selectedTgl = document.getElementById('globalFilterTgl').value;
            const filteredReports = rawReports.filter(r => r[9] === selectedTgl);
            renderWajib(filteredReports, selectedTgl);
            renderTemuan(); 
            renderPetugas(filteredReports, selectedTgl);
        }

        function renderWajib(reports, tgl) {
            const tbody = document.querySelector('#tableWajib tbody');
            tbody.innerHTML = "";
            let wTotal = 0, wDone = 0;
            const clean = (s) => s ? s.toString().split(' ')[0].trim().toUpperCase() : "";
            const regexKurungAngka = /\(\d+\)/;

            rawWajib.forEach((w, index) => {
                const fullText = w.KD_STORE || "";
                if (!regexKurungAngka.test(fullText)) return;
                const kdStore = clean(fullText);
                const masterSchedule = rawMaster.filter(m => clean(m.KD_STORE) === kdStore && String(m.TGL_PROSES) === String(tgl) && /^[KAM]/i.test(m.KONTAINER));
                
                if (masterSchedule.length === 0) return;
                wTotal++;
                
                const listWajib = [...new Set(masterSchedule.map(m => m.KONTAINER.trim().toUpperCase()))];
                const listDone = [...new Set(reports.filter(r => clean(r[3]) === kdStore).map(r => r[5].trim().toUpperCase()))];
                const listSisa = listWajib.filter(k => !listDone.includes(k));
                const isDone = listSisa.length === 0;
                
                if(isDone) wDone++;

                tbody.innerHTML += `
                    <tr>
                        <td style="vertical-align: top; width: 40%;">
                            <strong>${fullText}</strong><br>
                            <small>${w.NAMA_STORE || ''}</small><br>
                            <span class="badge ${isDone ? 'badge-green' : 'badge-red'}">${isDone ? 'COMPLETE' : 'INCOMPLETE'}</span>
                        </td>
                        <td>
                            <div style="display: flex; gap: 10px; background: #f8f9fa; padding: 10px; border-radius: 6px; font-size: 0.75rem; align-items: center; border: 1px solid #eee;">
                                <div>PICKING: <strong>${listWajib.length}</strong></div>
                                <div style="color: #3498db;">SAMPLING: <strong>${listDone.length}</strong></div>
                                <div style="color: #e74c3c;">SISA: <strong>${listSisa.length}</strong></div>
                                ${!isDone ? `<button id="btn-${index}" class="btn-toggle" onclick="toggleDetail(${index})"><i class="fas fa-eye"></i> Detail Sisa</button>` : ''}
                            </div>
                            <div id="detail-${index}" class="detail-sisa">
                                <div style="background: #fff5f5; padding: 10px; border-radius: 6px; border: 1px solid #feb2b2;">
                                    <span class="kon-list">${listSisa.join(', ')}</span>
                                </div>
                            </div>
                        </td>
                    </tr>`;
            });
            document.getElementById('wTotal').innerText = wTotal;
            document.getElementById('wDone').innerText = wDone;
            document.getElementById('wPending').innerText = wTotal - wDone;
        }

        function renderTemuan() {
            const perfMap = {}; const temuanMap = {};
            rawReports.forEach(r => {
                const tgl = r[9] || "Unknown";
                if (!perfMap[tgl]) perfMap[tgl] = { toko: new Set(), kon: 0 };
                perfMap[tgl].toko.add(r[3]); perfMap[tgl].kon++;
                if (!temuanMap[tgl]) temuanMap[tgl] = { toko: new Set(), kon: 0 };
                if (parseInt(r[8]) !== 0) { temuanMap[tgl].toko.add(r[3]); temuanMap[tgl].kon++; }
            });

            const labels = Object.keys(perfMap).sort().reverse().slice(0, 5).reverse();
            const dataPersentase = labels.map(l => ((temuanMap[l].kon / perfMap[l].kon) * 100).toFixed(1));

            const ctx = document.getElementById('chartTemuan').getContext('2d');
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, { 
                type: 'bar', 
                data: { 
                    labels: labels, 
                    datasets: [
                        { label: 'Sampling (Kon)', data: labels.map(l => perfMap[l].kon), backgroundColor: 'rgba(52, 152, 219, 0.8)', borderRadius: 5, yAxisID: 'y' }, 
                        { label: 'Selisih (Kon)', data: labels.map(l => temuanMap[l].kon), backgroundColor: 'rgba(231, 76, 60, 0.8)', borderRadius: 5, yAxisID: 'y' },
                        { label: '% Rasio', data: dataPersentase, type: 'line', borderColor: '#f39c12', borderWidth: 3, tension: 0.4, fill: false, yAxisID: 'y1' }
                    ] 
                }, 
                options: { 
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'top', labels: { usePointStyle: true, boxWidth: 6 } } },
                    scales: { y: { beginAtZero: true, grid: { display: false } }, y1: { beginAtZero: true, position: 'right', grid: { drawOnChartArea: false } } }
                } 
            });

            document.querySelector('#tableTemuan tbody').innerHTML = labels.slice().reverse().map(l => {
                const pToko = ((temuanMap[l].toko.size / perfMap[l].toko.size) * 100).toFixed(1);
                const pKon = ((temuanMap[l].kon / perfMap[l].kon) * 100).toFixed(1);
                return `<tr>
                    <td><i class="fas fa-calendar-day" style="color:#94a3b8; margin-right:8px;"></i>${l}</td>
                    <td><div style="font-weight:bold;">${perfMap[l].toko.size} Toko</div><small>${perfMap[l].kon} Kon</small></td>
                    <td>
                        <div><span style="font-weight:bold; color:#e11d48;">${temuanMap[l].toko.size} Toko</span> <span class="pct-badge pct-selisih">${pToko}%</span></div>
                        <div style="font-size:0.75rem;">${temuanMap[l].kon} Kon <span style="color:#e11d48; font-weight:600;">(${pKon}%)</span></div>
                    </td>
                </tr>`;
            }).join('');
        }

        // --- REVISI FUNGSI 3 (HEADER ANGKA) ---
        function renderPetugas(reports, selectedTgl) {
            const tbodySudah = document.querySelector('#tablePetugasSudah tbody');
            const tbodyBelum = document.querySelector('#tablePetugasBelum tbody');
            tbodySudah.innerHTML = ""; tbodyBelum.innerHTML = "";

            const norm = (n) => n ? n.toString().replace(/^0+/, '').trim() : "";
            
            // Ambil angka tanggal dari format "01-Dec-25" -> 1
            const daySelected = parseInt(selectedTgl.split('-')[0]); 

            let dataSudah = [], dataBelum = [];

            rawPetugas.forEach(p => {
                const nikMaster = norm(p.NIK || p.nik);
                const namaMaster = p.NAMA || p.nama;
                
                // Membaca shift dari properti objek sesuai angka tanggal
                const shiftRaw = (p[daySelected] || "").toString().trim().toUpperCase();
                
                // Filter: Lewati jika Libur (O), Cuti (C), Off, atau Kosong
                if (["O", "C", "OFF", "OFF S3", "CUTI", "LIBUR", ""].includes(shiftRaw)) return;

                const pRep = reports.filter(r => norm(r[1]) === nikMaster);

                if (pRep.length > 0) {
                    dataSudah.push({ 
                        nama: namaMaster, 
                        nik: p.NIK || p.nik, 
                        shift: shiftRaw, 
                        toko: [...new Set(pRep.map(r => r[3]))].length, 
                        total: pRep.length 
                    });
                } else {
                    dataBelum.push({ 
                        nama: namaMaster, 
                        nik: p.NIK || p.nik, 
                        shift: shiftRaw 
                    });
                }
            });

            // Update Counter UI
            document.getElementById('countBelum').innerText = `${dataBelum.length} Orang`;
            document.getElementById('countSudah').innerText = `${dataSudah.length} Orang`;

            // Render Belum Sampling
            dataBelum.sort((a, b) => getShiftWeight(a.shift) - getShiftWeight(b.shift)).forEach(item => {
                tbodyBelum.innerHTML += `<tr><td><b>${item.nama}</b></td><td>${item.nik}</td><td><span class="badge" style="background:#f1f5f9; color:#475569;">${item.shift}</span></td><td><span class="badge badge-red">MENUNGGU</span></td></tr>`;
            });

            // Render Sudah Sampling
            dataSudah.sort((a, b) => a.total - b.total).forEach(item => {
                const warningStyle = item.total < 5 ? 'color: #e74c3c; font-weight: bold;' : 'font-weight: bold;';
                tbodySudah.innerHTML += `<tr><td><b>${item.nama}</b><br><small style="color:#64748b;">NIK: ${item.nik}</small></td><td><span class="badge" style="background:#f1f5f9; color:#475569;">${item.shift}</span></td><td>${item.toko}</td><td style="${warningStyle}">${item.total} Kon</td></tr>`;
            });
        }

        const getShiftWeight = (shiftStr) => {
            if (!shiftStr) return 9999;
            const match = shiftStr.match(/^([A-Z])(\d+)/i);
            if (match) {
                const letter = match[1].toUpperCase();
                const number = parseInt(match[2]);
                if (CATEGORY_WEIGHT[letter] !== undefined) return CATEGORY_WEIGHT[letter] + number;
            }
            return 8000;
        };

        function toggleDetail(index) {
            const div = document.getElementById('detail-' + index);
            const btn = document.getElementById('btn-' + index);
            if (div.style.display === 'block') {
                div.style.display = 'none';
                btn.innerHTML = '<i class="fas fa-eye"></i> Detail Sisa';
            } else {
                div.style.display = 'block';
                btn.innerHTML = '<i class="fas fa-eye-slash"></i> Sembunyi';
            }
        }
    </script>
</body>
</html>
